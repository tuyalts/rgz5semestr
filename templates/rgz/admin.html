{% extends "base.html" %}
{% block lab %}–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞{% endblock %}
{% block head %}
    <style>
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .admin-table th, .admin-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .admin-table th { background: #5c0fae; color: white; }
        .admin-table tr:nth-child(even) { background: #f2f2f2; }
        .admin-table button { margin: 2px; padding: 5px 10px; cursor: pointer; }
        .edit-form { background: #f9f9f9; padding: 20px; border: 1px solid #ccc; margin-top: 20px; display: none; }
        .pagination { margin-top: 20px; }
        .pagination button { margin: 0 5px; padding: 5px 10px; }
    </style>
    <script src="{{ url_for('static', filename='js/rgz.js') }}"></script>
{% endblock %}
{% block main %}
    <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h1>
    <div id="users-container">
        <!-- –¢–∞–±–ª–∏—Ü–∞ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
        <table class="admin-table" id="users-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–õ–æ–≥–∏–Ω</th>
                    <th>–ò–º—è</th>
                    <th>–£—Å–ª—É–≥–∞</th>
                    <th>–°—Ç–∞–∂</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>–°–∫—Ä—ã—Ç</th>
                    <th>–ê–¥–º–∏–Ω</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="users-tbody">
                <tr><td colspan="9">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
            </tbody>
        </table>
        <div class="pagination" id="admin-pagination"></div>
    </div>

    <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–∫—Ä—ã—Ç–∞) -->
    <div id="edit-user-form" class="edit-form">
        <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <span id="edit-username"></span></h3>
        <input type="hidden" id="edit-user-id">
        <div>
            <label>–ò–º—è:</label>
            <input type="text" id="edit-name" required>
        </div>
        <div>
            <label>–£—Å–ª—É–≥–∞:</label>
            <input type="text" id="edit-service" required>
        </div>
        <div>
            <label>–°—Ç–∞–∂:</label>
            <input type="number" id="edit-experience" required>
        </div>
        <div>
            <label>–¶–µ–Ω–∞:</label>
            <input type="number" id="edit-price" required>
        </div>
        <div>
            <label>–û —Å–µ–±–µ:</label>
            <textarea id="edit-about"></textarea>
        </div>
        <div>
            <label>–°–∫—Ä—ã—Ç:</label>
            <input type="checkbox" id="edit-hidden">
        </div>
        <div>
            <label>–ê–¥–º–∏–Ω:</label>
            <input type="checkbox" id="edit-admin">
        </div>
        <button onclick="adminUpdateUser()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button onclick="hideEditForm()">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <script>
        // –¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
        let currentPage = 1;

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            loadAdminUsers(currentPage);
        };

        function loadAdminUsers(page) {
            callRPC('admin.get_all_users', { page: page, per_page: 10 }, function(result, error) {
                if (result) {
                    displayAdminUsers(result);
                }
            });
        }

        function displayAdminUsers(data) {
            const tbody = document.getElementById('users-tbody');
            tbody.innerHTML = '';
            if (data.users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td></tr>';
            } else {
                data.users.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.name}</td>
                        <td>${user.service_type}</td>
                        <td>${user.experience}</td>
                        <td>${user.price}</td>
                        <td>${user.is_hidden ? '–î–∞' : '–ù–µ—Ç'}</td>
                        <td>${user.is_admin ? '–î–∞' : '–ù–µ—Ç'}</td>
                        <td>
                            <button onclick="showEditForm(${user.id})">‚úèÔ∏è</button>
                            <button onclick="adminDeleteUser(${user.id})">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
            const pagination = document.getElementById('admin-pagination');
            pagination.innerHTML = '';
            if (data.page > 1) {
                pagination.innerHTML += `<button onclick="loadAdminUsers(${data.page - 1})">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>`;
            }
            pagination.innerHTML += `<span> –°—Ç—Ä–∞–Ω–∏—Ü–∞ ${data.page} –∏–∑ ${data.total_pages} </span>`;
            if (data.page < data.total_pages) {
                pagination.innerHTML += `<button onclick="loadAdminUsers(${data.page + 1})">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</button>`;
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function showEditForm(userId) {
            callRPC('user.get_profile', { user_id: userId }, function(result, error) {
                if (result) {
                    document.getElementById('edit-user-id').value = result.id;
                    document.getElementById('edit-username').innerText = result.username;
                    document.getElementById('edit-name').value = result.name;
                    document.getElementById('edit-service').value = result.service_type;
                    document.getElementById('edit-experience').value = result.experience;
                    document.getElementById('edit-price').value = result.price;
                    document.getElementById('edit-about').value = result.about || '';
                    document.getElementById('edit-hidden').checked = result.is_hidden;
                    document.getElementById('edit-admin').checked = result.is_admin;
                    document.getElementById('edit-user-form').style.display = 'block';
                }
            });
        }

        function hideEditForm() {
            document.getElementById('edit-user-form').style.display = 'none';
        }

        function adminUpdateUser() {
            const userId = document.getElementById('edit-user-id').value;
            const params = {
                user_id: parseInt(userId),
                name: document.getElementById('edit-name').value,
                service_type: document.getElementById('edit-service').value,
                experience: parseInt(document.getElementById('edit-experience').value),
                price: parseInt(document.getElementById('edit-price').value),
                about: document.getElementById('edit-about').value,
                is_hidden: document.getElementById('edit-hidden').checked,
                is_admin: document.getElementById('edit-admin').checked
            };
            callRPC('admin.update_user', params, function(result, error) {
                if (result) {
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω');
                    hideEditForm();
                    loadAdminUsers(currentPage); // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫
                }
            });
        }

        function adminDeleteUser(userId) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) {
                callRPC('admin.delete_user', { user_id: userId }, function(result, error) {
                    if (result) {
                        alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω');
                        loadAdminUsers(currentPage);
                    }
                });
            }
        }
    </script>
{% endblock %}